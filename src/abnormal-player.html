<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abnormal player ğŸš€</title>
    <!-- æ·»åŠ  SVG favicon -->
    <link rel="icon" href="../img/favicon.svg">
    <script src="../js/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 97vh;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            height: 30px;
            margin-bottom: 12px;
            flex-grow: 0;
            display: flex;
            align-items: center;
        }
        h1 {
            margin: 0;
            font-size: 24px;
        }
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            margin-bottom: 12px;
            flex-grow: 0;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: white;
            padding: 5px 10px;
            border-radius: 5px;
            height: 30px;
            padding: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .status {
            display: flex;
            padding: 10px;
            background-color: #e8f4fc;
            border-radius: 4px;
            font-size: 14px;
            align-items: center;
            font-weight: bold;
            color: #2c3e50;
        }
        label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        input[type="file"] {
            padding: 8px;
            background-color: white;
            height: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
        }
        .panel-header {
            display: flex;
            padding: 5px 20px;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            height: 20px;
            align-items: center;
        }
        .data-panel {
            width: 50%;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .data-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            position: absolute;
            top: 30px;
            bottom: 10px;
            left: 0;
            right: 0;
        }
        input[type="text"] {
            border: none;
            outline: none;
            background-color: transparent;
            padding: 0px;
            width: 100%;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 3px 3px;
            text-align: left;
            word-wrap: break-word;
            word-break: break-all;
            white-space: normal;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            font-weight: bold;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f0f0f0;
        }
        .time-cell {
            color: #2980b9;
            cursor: pointer;
            font-weight: bold;
        }
        .time-cell:hover {
            text-decoration: underline;
            color: #1a5276;
        }
        .video-panel {
            flex: 1;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .video-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 10px 15px;
        }
        video {
            width: 100%;
            max-height: 65vh;
            background-color: #000;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        #buttonContainer {
            display: flex;
            justify-content: center;
            /* å›ºå®šä½ç½® */
            bottom: 0;
            /* é”å®šåˆ°é¡µé¢åº•éƒ¨ */
            left: 0;
            height: 24px;
            max-height: 10%;
            width: 100%;
            padding: 0 0 8px 0;
            gap: 5px;
        }
        .currenttext {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%;
            height: 24px;
            font-size: 18px;
            color: #333;
        }
        #currentTimeDisplay{
            display: flex;
            width: 160px;
            height: 24px;
            font-size: 18px;
            color: #333;
            align-items: center;
            text-align: center;
        }
        .controlbutton {
            width: 30px;
            height: 24px;
            font-size: 24px;
            cursor: pointer;
            background-color: white;
            display: flex;
            align-items: center;    /* å‚ç›´å±…ä¸­ */
            justify-content: center; /* æ°´å¹³å±…ä¸­ */
        }
        button {
            padding: 5px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .highlight {
            background-color: #fffacd !important;
            box-shadow: 0 0 0 rgba(255, 235, 59, 0.6);
        }
        .current-time {
            position: absolute;
            right: 20px;
            top: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>å¼‚å¸¸æ•°æ®å¤æŸ¥</h1>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="excelFile">åˆ‡ç‰‡æ–‡ä»¶:</label>
            <input type="file" id="excelFile" accept=".xlsx, .xls" />
        </div>
        <div class="control-group">
            <label for="videoFile">è§†é¢‘æ–‡ä»¶:</label>
            <input type="file" id="videoFile" accept="video/*" />
        </div>
        <!-- <div class="control-group">
            <label for="nrhoption">å¯¼å…¥æ‹ŸäººåŒ–</label>
            <input type="radio" id="optionNo" name="importData" value="no" >
            <label for="optionNoNo">å¦</label>
            <input type="radio" id="optionYes" name="importData" value="yes" checked>
            <label for="optionYes">æ˜¯</label>
        </div> -->
        <button id="exportButton">å¯¼å‡ºæ–‡ä»¶</button>
        <div class="status" id="status">
            è¯·åŠ è½½åˆ‡ç‰‡æ–‡ä»¶
        </div>
        <div class="status" id="videoStatus">
            è¯·åŠ è½½è§†é¢‘æ–‡ä»¶
        </div>
    </div>
    
    <div class="container">
        <div class="data-panel">
            <div class="panel-header">
                åœºæ™¯æ•°æ®
            </div>
            <div class="data-container" id="dataContainer">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th style="width: 16%;">çº¿è·¯åç§°</th>
                            <th style="width: 8%;">è½¦å‹</th>
                            <th style="width: 5%;">ç¼–å·</th>
                            <th style="width: 10%;">è§†é¢‘åç§°</th>
                            <th style="width: 7%;">å¼€å§‹æ—¶é—´</th>
                            <th style="width: 7%;">ç»“æŸæ—¶é—´</th>
                            <th style="width: 5%;">æ ‡ç­¾</th>
                            <th style="width: 10%;">æ¥ç®¡ç±»å‹</th>
                            <th style="width: 16%;">æè¿°ä¸åŸå› </th>
                            <th style="width: 16%;">å¤æŸ¥æ„è§</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                        <!-- æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="video-panel">
            <div class="panel-header">
                è§†é¢‘æ’­æ”¾
            </div>
            <div class="video-container">
                <!-- <div class="current-time" id="currentTime">00:00:00</div> -->
                <video id="videoPlayer" controls>
                    <source src="" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
            </div>
            <div class="currenttext" id="currentLabel">å½“å‰æ ‡ç­¾</div>
            <div id="buttonContainer">
                <div id="currentTimeDisplay">å½“å‰æ—¶é—´: 00:00:00</div>
                <button id="rewindButton" class="controlbutton">âª</button>
                <button id="playButton" class="controlbutton">â–¶ï¸</button>
                <button id="fastForwardButton" class="controlbutton">â©</button>
            </div>
        </div>
    </div>

    <script>
        // è·å–DOMå…ƒç´ 
        const excelFileInput = document.getElementById('excelFile');
        const videoFileInput = document.getElementById('videoFile');
        const videoPlayer = document.getElementById('videoPlayer');
        const dataBody = document.getElementById('dataBody');
        const statusElement = document.getElementById('status');
        const videoStatusElement = document.getElementById('videoStatus');
        const currentTimeElement = document.getElementById('currentTime');
        const currentLable = document.getElementById('currentLabel');
        const playButton =document.getElementById('playButton');
        
        // å­˜å‚¨Excelæ•°æ®
        let sceneData = [];
        let highlightTimer = null;
        let lastHighlightedRow = null;
        let currentSceneIndex = -1
        
        // ç›‘å¬Excelæ–‡ä»¶é€‰æ‹©
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
           
            // æ¸…ç©ºåŸæ¥çš„ sceneData æ•°æ®
            sceneData = [];
            dataBody.innerHTML = ''; // æ¸…ç©ºè¡¨æ ¼å†…å®¹
            
            statusElement.textContent = `æ­£åœ¨åŠ è½½åœºæ™¯æ•°æ®: ${file.name}...`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // è½¬æ¢ä¸ºJSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    
                    // å¤„ç†æ•°æ®
                    processSceneData(jsonData);
                    
                    statusElement.textContent = `å·²åŠ è½½ ${sceneData.length} ä¸ªåœºæ™¯æ•°æ®`;
                } catch (error) {
                    statusElement.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        // ç›‘å¬è§†é¢‘æ–‡ä»¶é€‰æ‹©
        videoFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            videoStatusElement.textContent = `æ­£åœ¨åŠ è½½è§†é¢‘: ${file.name}...`;
            
            const videoURL = URL.createObjectURL(file);
            videoPlayer.src = videoURL;
            
            videoPlayer.onloadeddata = function() {
                videoStatusElement.textContent = `å·²åŠ è½½è§†é¢‘ (æ—¶é•¿: ${formatTime(videoPlayer.duration)})`;
                setupVideoTimeTracking();
            };
            
            videoPlayer.onerror = function() {
                videoStatusElement.textContent = "è§†é¢‘åŠ è½½å¤±è´¥";
            };
        });
        
        // è®¾ç½®è§†é¢‘æ—¶é—´è·Ÿè¸ª
        function setupVideoTimeTracking() {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (highlightTimer) {
                clearInterval(highlightTimer);
            }
            // æ›´æ–°å½“å‰æ—¶é—´æ˜¾ç¤º
            videoPlayer.ontimeupdate = function() {
                const currentTime = formatTime(videoPlayer.currentTime);
                currentTimeDisplay.textContent = `å½“å‰æ—¶é—´: ${currentTime}`;
                if (videoPlayer.paused) {
                    playButton.textContent = 'â–¶ï¸';
                } else {
                    playButton.textContent = 'â¸ï¸';
                }
            };
            // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦éœ€è¦é«˜äº®åœºæ™¯
            highlightTimer = setInterval(function() {
                checkCurrentSceneHighlight();
            }, 500);
        }
        
        // æ£€æŸ¥å¹¶é«˜äº®å½“å‰åœºæ™¯
        function checkCurrentSceneHighlight() {
            // if (!videoPlayer.src || sceneData.length === 0) return;
            
            // const currentTime = videoPlayer.currentTime;
            // let currentSceneIndex = -1;
            
            // // æŸ¥æ‰¾å½“å‰æ—¶é—´æ‰€åœ¨çš„åœºæ™¯
            // for (let i = 0; i < sceneData.length; i++) {
            //     const scene = sceneData[i];
            //     const startTime = convertToSeconds(formatExcelTime(scene.startTime));
            //     const endTime = convertToSeconds(formatExcelTime(scene.endTime));
                
            //     if (currentTime >= startTime && currentTime <= endTime) {
            //         currentSceneIndex = i;
            //         break;
            //     }
            // }
            
            // æ›´æ–°é«˜äº®çŠ¶æ€
            updateHighlight(currentSceneIndex);
        }
        
        // æ›´æ–°é«˜äº®è¡Œ
        function updateHighlight(rowIndex) {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            if (lastHighlightedRow !== null) {
                const rows = document.querySelectorAll('#dataBody tr');
                if (lastHighlightedRow >= 0 && lastHighlightedRow < rows.length) {
                    rows[lastHighlightedRow].classList.remove('highlight');
                }
            }

            // æ·»åŠ æ–°çš„é«˜äº®
            if (rowIndex >= 0) {
                const rows = document.querySelectorAll('#dataBody tr');
                if (rowIndex < rows.length) {
                    const currentRow = rows[rowIndex];
                    currentRow.classList.add('highlight');

                    // è·å–å½“å‰è¡Œçš„ labelInput
                    const labelInput = currentRow.querySelector('textarea');
                    console.log(`å½“å‰è¡Œçš„æ ‡ç­¾: ${sceneData[rowIndex].label}`);
                    if (sceneData[rowIndex].label) {
                        const labelMapping = {
                            1: "å·¦è½¬-æ— åšå¼ˆ",
                            2: "å·¦è½¬-åŒå‘è½¦è¾†åšå¼ˆ",
                            3: "å·¦è½¬-å¯¹å‘è½¬å¼¯è½¦è¾†åšå¼ˆ",
                            4: "å·¦è½¬-VRUåšå¼ˆ",
                            5: "å·¦è½¬-å¾…è¡ŒåŒº",
                            6: "ç›´è¡Œ-æ— åšå¼ˆ",
                            7: "ç›´è¡Œ-æœ‰åšå¼ˆ",
                            8: "ç›´è¡Œ-å¾…è¡ŒåŒº",
                            9: "å³è½¬-æ— åšå¼ˆ",
                            10: "å³è½¬-åŒå‘è½¦è¾†åšå¼ˆ",
                            11: "å³è½¬-å¯¹å‘è½¬å¼¯è½¦è¾†åšå¼ˆ",
                            12: "å³è½¬-VRUåšå¼ˆ",
                            13: "ç¯å²›-æœ‰ä¿¡å·ç¯",
                            14: "ç¯å²›-æ— ä¿¡å·ç¯",
                            15: "æ‰å¤´-æ— åšå¼ˆ",
                            16: "æ‰å¤´-æœ‰åšå¼ˆ",
                            17: "è½¦é“ä¿æŒä¸è·Ÿè½¦",
                            18: "æ‹¥å µè·Ÿè½¦",
                            19: "å¯¼èˆªå˜é“",
                            20: "åˆ‡å…¥é¿è®©",
                            21: "ç»•è¡Œå é“è½¦è¾†ä¸è¡Œäºº",
                            22: "çª„è·¯-ç»•è¡ŒåŒå‘è½¦è¾†ä¸VRU",
                            23: "è¶…è¶Šæ…¢è½¦",
                            24: "å¯¹å‘ä¼šè½¦",
                            25: "çª„è·¯-å¯¹å‘è½¦è¾†ä¸VRUåšå¼ˆ",
                            26: "çª„è·¯-æ‰å¤´",
                            27: "å‡ºä¸»è·¯è¿›è¾…è·¯",
                            28: "å‡ºè¾…è·¯è¿›ä¸»è·¯",
                            29: "åŸå¿«åŒé“å†…åˆ†æµ",
                            30: "åŸå¿«åŒé“å†…åˆæµ",
                            31: "ä¸ŠåŒé“æ±‡å…¥åŸå¿«",
                            32: "å‡ºåŸå¿«ä¸‹åŒé“",
                            33: "æ–½å·¥åŒºåŸŸé€šè¡Œ",
                            34: "å·¦è½¬-å¯¹å‘ç›´è¡Œè½¦è¾†åšå¼ˆ",
                            35: "å­¦æ ¡åŒºåŸŸé€šè¡Œ",
                            36: "éš§é“é€šè¡Œ",
                            37: "æ”¶è´¹ç«™é€šè¡Œ",
                            38: "äº¤è­¦-æœ‰æŒ‡æŒ¥",
                            39: "äº¤è­¦-æ— æŒ‡æŒ¥",
                            40: "è¿åäº¤è§„",
                            41: "é©¾é©¶å‘˜ç´§æ€¥å¹²é¢„åŠæ¥ç®¡",
                            42: "é©¾é©¶å‘˜ä¸»åŠ¨å¹²é¢„",
                            43: "ç³»ç»Ÿè¯·æ±‚æ¥ç®¡",
                            44: "æ— æ•ˆæ•°æ®",
                            45: "é¿è®©æ¨ªç©¿VRU",
                            46: "å¤æ‚ç‹­çª„å··é“é€šè¡Œ"
                        };

                        // æ›¿æ¢ labelInput çš„å†…å®¹
                        const updateLabel = ((String(sceneData[rowIndex].label)).replace(/ /g, 'ï¼Œ') || '').replace(/\b\d+\b/g, match => labelMapping[match] || match);
                        const difficulty = sceneData[rowIndex].difficulty;
                        console.log(`å½“å‰éš¾åº¦ï¼š${difficulty} å½“å‰æ ‡ç­¾: ${updateLabel}`);
                        currentLable.textContent = `éš¾åº¦:${difficulty} ${updateLabel}`;
                    }

                    // å¦‚æœè¡Œä¸åœ¨å¯è§†åŒºåŸŸå†…ï¼Œåˆ™æ»šåŠ¨åˆ°è¯¥è¡Œ
                    const rowRect = currentRow.getBoundingClientRect();
                    const containerRect = document.getElementById('dataContainer').getBoundingClientRect();

                    if (rowRect.bottom > containerRect.bottom || rowRect.top < containerRect.top) {
                        if (!videoPlayer.paused) {
                            currentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            }

            lastHighlightedRow = rowIndex;
        }

        // å¤„ç†åœºæ™¯æ•°æ®
        function processSceneData(data) {
            sceneData = [];
            data.forEach(row => {
                // æ£€æŸ¥å¿…éœ€å­—æ®µæ˜¯å¦å­˜åœ¨
                // if (row['ç¼–å·'] === undefined && row['åˆ‡åˆ†åœºæ™¯ç¼–å·'] === undefined) {
                //     return; // è·³è¿‡ä¸å®Œæ•´çš„æ•°æ®è¡Œ
                // }
                sceneData.push({
                    test: 'çº¿è·¯åç§°' in row ? row['çº¿è·¯åç§°'] : row['çº¿è·¯'] || '',
                    car: row['è½¦å‹'] || '',
                    number: 'æ ¸æŸ¥ç¼–å·' in row ? row['æ ¸æŸ¥ç¼–å·'] : row['ç¼–å·'],
                    video: row['è§†é¢‘åç§°'] || '',
                    startTime: row['æ¥ç®¡æ—¶åˆ»'] || '',
                    endTime: row['æ¢å¤æ—¶åˆ»'] || '',
                    takeover: row['æ¥ç®¡ç±»å‹/æ‹ŸäººåŒ–ç¨‹åº¦'] || '',
                    label: 'åœºæ™¯æ ‡ç­¾å·' in row ? row['åœºæ™¯æ ‡ç­¾å·'] :row['åœºæ™¯æ ‡ç­¾'] || '',
                    remark: 'æè¿°ä¸åŸå› ' in row ? row['æè¿°ä¸åŸå› '] : row['æè¿°'] || ''
                });
            });

            renderSceneData();
        }

        function addSceneData() {

        }
        // æ¸²æŸ“åœºæ™¯æ•°æ®è¡¨æ ¼
        function renderSceneData() {
            dataBody.innerHTML = '';
            
            sceneData.forEach((scene, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;

                // æµ‹è¯•åç§°
                const testCell = document.createElement('td');
                testCell.textContent = scene.test;
                testCell.style.textAlign = 'left';

                // è½¦å‹
                const carCell = document.createElement('td');
                carCell.textContent = scene.car;
                carCell.style.textAlign = 'center';

                // æ ¸æŸ¥ç¼–å·
                const numberCell = document.createElement('td');
                numberCell.textContent = scene.number;
                numberCell.style.textAlign = 'center';

                // è§†é¢‘åç§°
                const videoCell = document.createElement('td');
                videoCell.textContent = scene.video;
                videoCell.style.textAlign = 'center';

                // å¼€å§‹æ—¶é—´
                const startCell = document.createElement('td');
                startCell.className = 'time-cell';
                startCell.textContent = formatExcelTime(scene.startTime);
                startCell.dataset.time = convertToSeconds(startCell.textContent);
                startCell.title = "ç‚¹å‡»è·³è½¬åˆ°åœºæ™¯å¼€å§‹æ—¶é—´";
                startCell.style.textAlign = 'center';
                startCell.onclick = function () {
                    locateSceneByTime(this.dataset.time, index);
                };

                // ç»“æŸæ—¶é—´
                const endCell = document.createElement('td');
                endCell.className = 'time-cell';
                endCell.textContent = formatExcelTime(scene.endTime);
                endCell.dataset.time = convertToSeconds(endCell.textContent);
                endCell.title = "ç‚¹å‡»è·³è½¬åˆ°åœºæ™¯ç»“æŸæ—¶é—´";
                endCell.style.textAlign = 'center';
                endCell.onclick = function () {
                    locateSceneByTime(this.dataset.time, index);
                };

                // åœºæ™¯æ ‡ç­¾
                const labelCell = document.createElement('td');
                labelCell.textContent = scene.label;
                labelCell.style.textAlign = 'center';

                // æ¥ç®¡ç±»å‹
                const takeoverCell = document.createElement('td');
                takeoverCell.textContent = scene.takeover;
                takeoverCell.style.textAlign = 'center';

                // å¼‚å¸¸æƒ…å†µå¤‡æ³¨
                const remarkCell = document.createElement('td');
                remarkCell.textContent = scene.remark;
                remarkCell.style.textAlign = 'left';

                // å¤æŸ¥æ„è§
                const checkCell = document.createElement('td');
                const checkInput = document.createElement('input');
                checkInput.type = 'text';
                checkInput.style.textAlign = 'left';
                checkInput.onchange = function () {
                    scene.check = this.value;
                };
                checkCell.appendChild(checkInput);

                // æ·»åŠ åˆ°è¡Œ
                row.appendChild(testCell);
                row.appendChild(carCell);
                row.appendChild(numberCell);
                row.appendChild(videoCell);
                row.appendChild(startCell);
                row.appendChild(endCell);
                row.appendChild(labelCell);
                row.appendChild(takeoverCell);
                row.appendChild(remarkCell);
                row.appendChild(checkCell);

                // æ·»åŠ åˆ°è¡¨æ ¼
                dataBody.appendChild(row);
            });
        }

        // æ–°å¢å‡½æ•°ï¼šæ ¹æ®æ—¶é—´æˆ³å®šä½åœºæ™¯
        function locateSceneByTime(timeInSeconds, rowIndex) {
            if (!videoPlayer.src) {
                videoStatusElement.textContent = "è¯·å…ˆåŠ è½½è§†é¢‘æ–‡ä»¶";
                return;
            }

            // è·³è½¬è§†é¢‘æ—¶é—´
            videoPlayer.currentTime = parseFloat(timeInSeconds);
            videoPlayer.play();

            // æ›´æ–°çŠ¶æ€
            videoStatusElement.textContent = `è·³è½¬åˆ°: ${formatTime(timeInSeconds)}`;

            // é«˜äº®å½“å‰è¡Œ
            currentSceneIndex = rowIndex;
        }
        
        // æ ¼å¼åŒ–Excelæ—¶é—´ï¼ˆæ”¯æŒæ—¥æœŸå¯¹è±¡ã€æ•°å­—æ ¼å¼å’Œå­—ç¬¦ä¸²æ ¼å¼ï¼‰
        function formatExcelTime(time) {
            if (time instanceof Date && isNaN(time.getTime())) {
            // å¦‚æœæ˜¯æ— æ•ˆçš„ Date å¯¹è±¡ï¼Œå°è¯•å°†å…¶è§†ä¸º Excel æ—¶é—´æ ¼å¼çš„æ•°å­—
            const rawValue = time.valueOf(); // è·å–åŸå§‹å€¼
            //const rawValue = time.v
            const numericValue = parseFloat(rawValue)
            const baseDate = new Date(Date.UTC(1899, 11, 30)); // Excel æ—¶é—´åŸºå‡†æ—¥æœŸï¼ˆUTC æ—¶é—´ï¼‰
            const excelDate = new Date(baseDate.getTime() + numericValue * 86400 * 1000); // è½¬æ¢ä¸ºæ¯«ç§’
            const hours = excelDate.getUTCHours().toString().padStart(2, '0');
            const minutes = excelDate.getUTCMinutes().toString().padStart(2, '0');
            const seconds = excelDate.getUTCSeconds().toString().padStart(2, '0');
            console.log(`æ—¶é—´æ ¼å¼ä¸º: datenumber ${time} ${hours}:${minutes}:${seconds}`);
            return `${hours}:${minutes}:${seconds}`;
            } else if (time instanceof Date) {
                // å¤„ç†æ—¥æœŸå¯¹è±¡
                const hours = time.getHours().toString().padStart(2, '0');
                const minutes = time.getMinutes().toString().padStart(2, '0');
                const seconds = time.getSeconds().toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            } else if (typeof time === 'number') {
                // å¤„ç†Excelæ•°å­—æ—¶é—´æ ¼å¼ï¼ˆ1 = 1å¤© = 24å°æ—¶ï¼‰
                const totalSeconds = time * 86400;
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            } else if (typeof time === 'string' && /^\d{1,2}:\d{2}:\d{2}$/.test(time)) {
                // å¤„ç†å­—ç¬¦ä¸²æ ¼å¼çš„æ—¶é—´ï¼ˆH:MM:SS æˆ– HH:MM:SSï¼‰
                const parts = time.split(':');
                if (parts[0].length === 1) {
                    // å¦‚æœå°æ—¶éƒ¨åˆ†æ˜¯å•ä¸ªæ•°å­—ï¼Œè¡¥é½ä¸ºä¸¤ä½
                    parts[0] = parts[0].padStart(2, '0');
                }
                return parts.join(':');
            }
            return time; // å¦‚æœä¸æ˜¯æ—¶é—´æ ¼å¼ï¼Œè¿”å›åŸå§‹å€¼
        }
        
        // å°†æ—¶é—´è½¬æ¢ä¸ºç§’æ•°
        // function convertToSeconds(time) {
        //     if (time instanceof Date) {
        //         return time.getHours() * 3600 + time.getMinutes() * 60 + time.getSeconds();
        //     } else if (typeof time === 'number') {
        //         return time * 86400; // Excelæ—¶é—´æ ¼å¼ï¼Œ1 = 24å°æ—¶
        //     }
        //     return 0;
        // }

        function convertToSeconds(timeString) {
            if (typeof timeString === 'string' && /^\d{2}:\d{2}:\d{2}$/.test(timeString)) {
                const [hours, minutes, seconds] = timeString.split(':').map(Number);
                return hours * 3600 + minutes * 60 + seconds;
            }
            return 0; // å¦‚æœæ ¼å¼ä¸æ­£ç¡®ï¼Œè¿”å›0
        }
        
        // æ ¼å¼åŒ–æ—¶é—´ä¸ºHH:MM:SS
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${secs}`;
        }
        
        // è·³è½¬åˆ°è§†é¢‘æŒ‡å®šæ—¶é—´
        function jumpToVideoTime(timeInSeconds, rowIndex) {
            if (!videoPlayer.src) {
                videoStatusElement.textContent = "è¯·å…ˆåŠ è½½è§†é¢‘æ–‡ä»¶";
                return;
            }
            
            // è·³è½¬è§†é¢‘æ—¶é—´
            videoPlayer.currentTime = parseFloat(timeInSeconds);
            videoPlayer.play();
            
            // æ›´æ–°çŠ¶æ€
            videoStatusElement.textContent = `è·³è½¬åˆ°: ${formatTime(timeInSeconds)}`;
            
            // é«˜äº®å½“å‰è¡Œ
            updateHighlight(rowIndex);
        }

        // è·å–å¯¼å‡ºæŒ‰é’®
        const exportButton = document.getElementById('exportButton');
        let loadedExcelFileName = ''; // ç”¨äºå­˜å‚¨åŠ è½½çš„Excelæ–‡ä»¶å

        // åœ¨åŠ è½½Excelæ–‡ä»¶æ—¶ï¼Œä¿å­˜æ–‡ä»¶å
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadedExcelFileName = file.name.split('.').slice(0, -1).join('.'); // å»æ‰æ‰©å±•å
            }
        });

        // å¯¼å‡ºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        exportButton.addEventListener('click', function() {
            if (sceneData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„åœºæ™¯æ•°æ®ï¼');
                return;
            }

            // åˆ›å»ºå·¥ä½œè¡¨
            const worksheet = XLSX.utils.json_to_sheet(sceneData.map(scene => ({
                çº¿è·¯åç§°: scene.test,
                è½¦å‹: scene.car,
                æ ¸æŸ¥ç¼–å·: scene.number,
                è§†é¢‘åç§°: scene.video,
                å¼€å§‹æ—¶é—´: scene.startTime,
                ç»“æŸæ—¶é—´: scene.endTime,
                åœºæ™¯æ ‡ç­¾: scene.label,
                æè¿°ä¸åŸå› : scene.remark,
                å¤æŸ¥æ„è§: scene.check
            })));
            // è®¾ç½®å•å…ƒæ ¼æ ¼å¼ä¸ºæ•°å­—
            ['C'].forEach(col => {
                for (let row = 2; row <= sceneData.length + 1; row++) {
                    const cell = worksheet[`${col}${row}`];
                    if (cell) {
                        cell.t = 'n'; // è®¾ç½®å•å…ƒæ ¼ç±»å‹ä¸ºæ•°å­—
                    }
                }
            });
            // è®¾ç½®å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ä¸ºæ—¶é—´æ ¼å¼
            ['E', 'F'].forEach(col => {
                for (let row = 2; row <= sceneData.length + 1; row++) {
                    const cell = worksheet[`${col}${row}`];
                    if (cell) {
                        cell.z = 'hh:mm:ss'; // è®¾ç½®å•å…ƒæ ¼æ ¼å¼ä¸ºæ—¶é—´
                    }
                }
            });
            // è®¾ç½® F å’Œ K åˆ—ä¸ºæ–‡æœ¬æ ¼å¼
            ['A', 'B', 'D', 'G', 'H', 'I'].forEach(col => {
                for (let row = 2; row <= sceneData.length + 1; row++) {
                    const cell = worksheet[`${col}${row}`];
                    if (cell) {
                        cell.t = 's'; // è®¾ç½®å•å…ƒæ ¼ç±»å‹ä¸ºæ–‡æœ¬
                    }
                }
            });
            // åˆ›å»ºå·¥ä½œç°¿
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'æ ¡éªŒæ•°æ®');

            // è®¾ç½®å¯¼å‡ºçš„æ–‡ä»¶å
            const exportFileName = `${loadedExcelFileName || 'åœºæ™¯æ•°æ®'}_å¤æŸ¥.xlsx`;

            // å¯¼å‡ºæ–‡ä»¶
            XLSX.writeFile(workbook, exportFileName);
        });

        // æ’­æ”¾æš‚åœ
        document.getElementById('playButton').addEventListener('click', function () {
            if (videoPlayer.paused) {
                videoPlayer.play();
            }
            else {
                videoPlayer.pause();
            }
        });
        // å¿«è¿›
        document.getElementById('fastForwardButton').addEventListener('click', function () {
            if (videoPlayer) {
                videoPlayer.currentTime += 1; // å¿«è¿›1ç§’
            }
        });
         // åé€€
        document.getElementById('rewindButton').addEventListener('click', function () {
            if (videoPlayer) {
                videoPlayer.currentTime -= 1; // åé€€1ç§’
            }
        });

    </script>
</body>
</html>