<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check player ğŸš€</title>
    <!-- æ·»åŠ  SVG favicon -->
    <link rel="icon" href="../img/favicon.svg">
    <script src="../js/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            height: 97vh;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            height: 30px;
            margin-bottom: 12px;
            flex-grow: 0;
            display: flex;
            align-items: center;
        }
        h1 {
            margin: 0;
            font-size: 24px;
        }
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            margin-bottom: 12px;
            flex-grow: 0;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: white;
            padding: 5px 10px;
            border-radius: 5px;
            height: 30px;
            padding: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .file-input {
            width: 500px;
        }
        /* æ·»åŠ æ‹–æ‹½åŒºåŸŸæ ·å¼ */
        .file-input.dragover {
            border: 2px dashed #3498db !important;
            background-color: #e8f4fc !important;
        }
        .status {
            display: flex;
            padding: 10px;
            background-color: #e8f4fc;
            border-radius: 4px;
            font-size: 14px;
            align-items: center;
            font-weight: bold;
            color: #2c3e50;
        }
        label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        input[type="file"] {
            padding: 8px;
            background-color: white;
            height: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
        }
        .panel-header {
            display: flex;
            padding: 5px 20px;
            background-color: #3498db;
            color: white;
            font-weight: bold;
            height: 20px;
            align-items: center;
        }
        .data-panel {
            width: 40%;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .data-container {
            flex: 1;
            overflow-y: auto;
            padding: 10px 15px;
            position: absolute;
            top: 30px;
            bottom: 10px;
            left: 0;
            right: 0;
        }
        input[type="text"] {
            border: none;
            outline: none;
            background-color: transparent;
            padding: 0px;
            width: 100%;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 3px 3px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            font-weight: bold;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f0f0f0;
        }
        .time-cell {
            color: #2980b9;
            cursor: pointer;
            font-weight: bold;
        }
        .time-cell:hover {
            text-decoration: underline;
            color: #1a5276;
        }
        .video-panel {
            flex: 1;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .video-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 10px 15px;
        }
        video {
            width: 100%;
            max-height: 65vh;
            background-color: #000;
            border-radius: 4px;
            margin-bottom: 5px;
        }
        #buttonContainer {
            display: flex;
            justify-content: center;
            bottom: 0;
            left: 0;
            height: 24px;
            max-height: 10%;
            width: 100%;
            padding: 0 0 8px 0;
            gap: 5px;
        }
        .currenttext {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            width: 100%;
            height: 24px;
            font-size: 18px;
            color: #333;
        }
        #currentTimeDisplay{
            display: flex;
            width: 160px;
            height: 24px;
            font-size: 18px;
            color: #333;
            align-items: center;
            text-align: center;
        }
        .controlbutton {
            width: 30px;
            height: 24px;
            font-size: 24px;
            cursor: pointer;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button {
            padding: 5px 10px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .highlight {
            background-color: #fffacd !important;
            box-shadow: 0 0 0 rgba(255, 235, 59, 0.6);
        }
        .current-time {
            position: absolute;
            right: 20px;
            top: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ±‡æ€»ç”¨æ”¹ç‰ˆ</h1>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label for="excelFile">åˆ‡ç‰‡æ–‡ä»¶:</label>
            <input type="file" id="excelFile" accept=".xlsx, .xls" class="file-input" />
        </div>
        <div class="control-group">
            <label for="videoFile">è§†é¢‘æ–‡ä»¶:</label>
            <input type="file" id="videoFile" accept="video/*" class="file-input" />
        </div>
        <button id="exportButton">å¯¼å‡ºæ–‡ä»¶</button>
        <div class="status" id="status">
            è¯·åŠ è½½åˆ‡ç‰‡æ–‡ä»¶
        </div>
        <div class="status" id="videoStatus">
            è¯·åŠ è½½è§†é¢‘æ–‡ä»¶
        </div>
    </div>
    
    <div class="container">
        <div class="data-panel">
            <div class="panel-header">
                åœºæ™¯æ•°æ®
            </div>
            <div class="data-container" id="dataContainer">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th style="width: 6%;">ç¼–å·</th>
                            <th style="width: 12%;">å¼€å§‹æ—¶é—´</th>
                            <th style="width: 12%;">ç»“æŸæ—¶é—´</th>
                            <th style="width: 12%;">åœºæ™¯æ ‡ç­¾</th>
                            <th style="width: 6%;">éš¾åº¦</th>
                            <th style="width: 17%;">å¼‚å¸¸æƒ…å†µå¤‡æ³¨</th>
                            <th style="width: 6%;">å®‰å…¨</th>
                            <th style="width: 6%;">æ•ˆç‡</th>
                            <th style="width: 6%;">èˆ’é€‚</th>
                            <th style="width: 17%;">æ‹ŸäººåŒ–å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="dataBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="video-panel">
            <div class="panel-header">
                è§†é¢‘æ’­æ”¾
            </div>
            <div class="video-container">
                <video id="videoPlayer" controls>
                    <source src="" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
            </div>
            <div class="currenttext" id="currentLabel">å½“å‰æ ‡ç­¾</div>
            <div id="buttonContainer">
                <div id="currentTimeDisplay">å½“å‰æ—¶é—´: 00:00:00</div>
                <button id="rewindButton" class="controlbutton">âª</button>
                <button id="playButton" class="controlbutton">â–¶ï¸</button>
                <button id="fastForwardButton" class="controlbutton">â©</button>
            </div>
        </div>
    </div>

    <script>
        const excelFileInput = document.getElementById('excelFile');
        const videoFileInput = document.getElementById('videoFile');
        const videoPlayer = document.getElementById('videoPlayer');
        const dataBody = document.getElementById('dataBody');
        const statusElement = document.getElementById('status');
        const videoStatusElement = document.getElementById('videoStatus');
        const currentTimeElement = document.getElementById('currentTime');
        const currentLable = document.getElementById('currentLabel');
        const playButton =document.getElementById('playButton');
        
        let sceneData = [];
        let highlightTimer = null;
        let lastHighlightedRow = null;
        let sceneCounter = 0;
        
        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
           
            sceneData = [];
            dataBody.innerHTML = '';
            
            statusElement.textContent = `æ­£åœ¨åŠ è½½åœºæ™¯æ•°æ®: ${file.name}...`;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
                    
                    processSceneData(jsonData);
                    
                    statusElement.textContent = `å·²åŠ è½½ ${sceneData.length} ä¸ªåœºæ™¯æ•°æ®`;
                } catch (error) {
                    statusElement.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨åˆ°Excelæ–‡ä»¶è¾“å…¥æ¡†
        excelFileInput.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        excelFileInput.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        excelFileInput.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // åˆ›å»ºä¸€ä¸ªäº‹ä»¶æ¥è§¦å‘æ–‡ä»¶é€‰æ‹©
                const event = new Event('change', { bubbles: true });
                this.files = files;
                this.dispatchEvent(event);
            }
        });
        
        videoFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            videoStatusElement.textContent = `æ­£åœ¨åŠ è½½è§†é¢‘: ${file.name}...`;
            
            const videoURL = URL.createObjectURL(file);
            videoPlayer.src = videoURL;
            
            videoPlayer.onloadeddata = function() {
                videoStatusElement.textContent = `å·²åŠ è½½è§†é¢‘ (æ—¶é•¿: ${formatTime(videoPlayer.duration)})`;
                setupVideoTimeTracking();
            };
            
            videoPlayer.onerror = function() {
                videoStatusElement.textContent = "è§†é¢‘åŠ è½½å¤±è´¥";
            };
        });
        
        // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨åˆ°è§†é¢‘æ–‡ä»¶è¾“å…¥æ¡†
        videoFileInput.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });
        
        videoFileInput.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });
        
        videoFileInput.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                // åˆ›å»ºä¸€ä¸ªäº‹ä»¶æ¥è§¦å‘æ–‡ä»¶é€‰æ‹©
                const event = new Event('change', { bubbles: true });
                this.files = files;
                this.dispatchEvent(event);
            }
        });
        
        function setupVideoTimeTracking() {
            if (highlightTimer) {
                clearInterval(highlightTimer);
            }
            videoPlayer.ontimeupdate = function() {
                const currentTime = formatTime(videoPlayer.currentTime);
                currentTimeDisplay.textContent = `å½“å‰æ—¶é—´: ${currentTime}`;
                if (videoPlayer.paused) {
                    playButton.textContent = 'â–¶ï¸';
                } else {
                    playButton.textContent = 'â¸ï¸';
                }
            };
            highlightTimer = setInterval(function() {
                checkCurrentSceneHighlight();
            }, 1000);
        }
        
        function checkCurrentSceneHighlight() {
            if (!videoPlayer.src || sceneData.length === 0) return;
            
            const currentTime = videoPlayer.currentTime;
            let currentSceneIndex = -1;
            
            for (let i = 0; i < sceneData.length; i++) {
                const scene = sceneData[i];
                const startTime = convertToSeconds(formatExcelTime(scene.startTime));
                const endTime = convertToSeconds(formatExcelTime(scene.endTime));
                
                if (currentTime >= startTime && currentTime <= endTime) {
                    currentSceneIndex = i;
                    break;
                }
            }
            
            updateHighlight(currentSceneIndex);
        }
        
        function updateHighlight(rowIndex) {
            if (lastHighlightedRow !== null) {
                const rows = document.querySelectorAll('#dataBody tr');
                if (lastHighlightedRow >= 0 && lastHighlightedRow < rows.length) {
                    rows[lastHighlightedRow].classList.remove('highlight');
                }
            }

            if (rowIndex >= 0) {
                const rows = document.querySelectorAll('#dataBody tr');
                if (rowIndex < rows.length) {
                    const currentRow = rows[rowIndex];
                    currentRow.classList.add('highlight');

                    const labelInput = currentRow.querySelector('textarea');
                    if (sceneData[rowIndex].label) {
                        const labelMapping = {
                            1: "å·¦è½¬-æ— åšå¼ˆ",
                            2: "å·¦è½¬-åŒå‘è½¦è¾†åšå¼ˆ",
                            3: "å·¦è½¬-å¯¹å‘è½¬å¼¯è½¦è¾†åšå¼ˆ",
                            4: "å·¦è½¬-VRUåšå¼ˆ",
                            5: "å·¦è½¬-å¾…è¡ŒåŒº",
                            6: "ç›´è¡Œ-æ— åšå¼ˆ",
                            7: "ç›´è¡Œ-æœ‰åšå¼ˆ",
                            8: "ç›´è¡Œ-å¾…è¡ŒåŒº",
                            9: "å³è½¬-æ— åšå¼ˆ",
                            10: "å³è½¬-åŒå‘è½¦è¾†åšå¼ˆ",
                            11: "å³è½¬-å¯¹å‘è½¬å¼¯è½¦è¾†åšå¼ˆ",
                            12: "å³è½¬-VRUåšå¼ˆ",
                            13: "ç¯å²›-æœ‰ä¿¡å·ç¯",
                            14: "ç¯å²›-æ— ä¿¡å·ç¯",
                            15: "æ‰å¤´-æ— åšå¼ˆ",
                            16: "æ‰å¤´-æœ‰åšå¼ˆ",
                            17: "è½¦é“ä¿æŒä¸è·Ÿè½¦",
                            18: "æ‹¥å µè·Ÿè½¦",
                            19: "å¯¼èˆªå˜é“",
                            20: "åˆ‡å…¥é¿è®©",
                            21: "ç»•è¡Œå é“è½¦è¾†ä¸è¡Œäºº",
                            22: "çª„è·¯-ç»•è¡ŒåŒå‘è½¦è¾†ä¸VRU",
                            23: "è¶…è¶Šæ…¢è½¦",
                            24: "å¯¹å‘ä¼šè½¦",
                            25: "çª„è·¯-å¯¹å‘è½¦è¾†ä¸VRUåšå¼ˆ",
                            26: "çª„è·¯-æ‰å¤´",
                            27: "å‡ºä¸»è·¯è¿›è¾…è·¯",
                            28: "å‡ºè¾…è·¯è¿›ä¸»è·¯",
                            29: "åŸå¿«åŒé“å†…åˆ†æµ",
                            30: "åŸå¿«åŒé“å†…åˆæµ",
                            31: "ä¸ŠåŒé“æ±‡å…¥åŸå¿«",
                            32: "å‡ºåŸå¿«ä¸‹åŒé“",
                            33: "æ–½å·¥åŒºåŸŸé€šè¡Œ",
                            34: "å·¦è½¬-å¯¹å‘ç›´è¡Œè½¦è¾†åšå¼ˆ",
                            35: "å­¦æ ¡åŒºåŸŸé€šè¡Œ",
                            36: "éš§é“é€šè¡Œ",
                            37: "æ”¶è´¹ç«™é€šè¡Œ",
                            38: "äº¤è­¦-æœ‰æŒ‡æŒ¥",
                            39: "äº¤è­¦-æ— æŒ‡æŒ¥",
                            40: "è¿åäº¤è§„",
                            41: "é©¾é©¶å‘˜ç´§æ€¥å¹²é¢„åŠæ¥ç®¡",
                            42: "é©¾é©¶å‘˜ä¸»åŠ¨å¹²é¢„",
                            43: "ç³»ç»Ÿè¯·æ±‚æ¥ç®¡",
                            44: "æ— æ•ˆæ•°æ®",
                            45: "é¿è®©æ¨ªç©¿VRU",
                            46: "å¤æ‚ç‹­çª„å··é“é€šè¡Œ"
                        };

                        const updateLabel = ((String(sceneData[rowIndex].label)).replace(/ /g, 'ï¼Œ') || '').replace(/\b\d+\b/g, match => labelMapping[match] || match);
                        currentLable.textContent = `${updateLabel}`;
                    }

                    const rowRect = currentRow.getBoundingClientRect();
                    const containerRect = document.getElementById('dataContainer').getBoundingClientRect();

                    if (rowRect.bottom > containerRect.bottom || rowRect.top < containerRect.top) {
                        if (!videoPlayer.paused) {
                            currentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            }

            lastHighlightedRow = rowIndex;
        }

        function processSceneData(data) {
            sceneData = [];
            const nrhOption = false;
            data.forEach(row => {
                sceneData.push({
                    number: 'åˆ‡åˆ†åœºæ™¯ç¼–å·' in row ? row['åˆ‡åˆ†åœºæ™¯ç¼–å·'] : row['ç¼–å·'],
                    startTime: 'åœºæ™¯å¼€å§‹æ—¶é—´æˆ³' in row ? row['åœºæ™¯å¼€å§‹æ—¶é—´æˆ³'] : row['å¼€å§‹æ—¶é—´'] || '',
                    endTime: 'åœºæ™¯ç»“æŸæ—¶é—´æˆ³' in row ? row['åœºæ™¯ç»“æŸæ—¶é—´æˆ³'] : row['ç»“æŸæ—¶é—´'] || '',
                    label: 'åœºæ™¯æ ‡ç­¾å·' in row ? row['åœºæ™¯æ ‡ç­¾å·'] : row['åœºæ™¯æ ‡ç­¾'] || '',
                    difficulty: 'åœºæ™¯éš¾æ˜“ç¨‹åº¦' in row ? row['åœºæ™¯éš¾æ˜“ç¨‹åº¦'] : ('åœºæ™¯éš¾åº¦' in row ? row['åœºæ™¯éš¾åº¦'] : row['éš¾åº¦'] || ''),
                    remark: 'å¼‚å¸¸æƒ…å†µå¤‡æ³¨' in row ? row['å¼‚å¸¸æƒ…å†µå¤‡æ³¨'] : row['æè¿°'] || '',
                    anquan: nrhOption ? '' : ('å®‰å…¨æ€§å¾—åˆ†' in row ? row['å®‰å…¨æ€§å¾—åˆ†'] : ('å®‰å…¨' in row ? row['å®‰å…¨'] : '')),
                    xiaolv: nrhOption ? '' : ('æ•ˆç‡æ€§å¾—åˆ†' in row ? row['æ•ˆç‡æ€§å¾—åˆ†'] : ('æ•ˆç‡' in row ? row['æ•ˆç‡'] : '')),
                    shushi: nrhOption ? '' : ('èˆ’é€‚æ€§å¾—åˆ†' in row ? row['èˆ’é€‚æ€§å¾—åˆ†'] : ('èˆ’é€‚' in row ? row['èˆ’é€‚'] : '')),
                    nrhremark: nrhOption ? '' : ('æ‹ŸäººåŒ–å¼‚å¸¸æƒ…å†µå¤‡æ³¨' in row ? row['æ‹ŸäººåŒ–å¼‚å¸¸æƒ…å†µå¤‡æ³¨'] : ('æ‹ŸäººåŒ–æƒ…å†µå¤‡æ³¨' in row ? row['æ‹ŸäººåŒ–æƒ…å†µå¤‡æ³¨'] : ('æ‹ŸäººåŒ–æè¿°' in row ? row['æ‹ŸäººåŒ–æè¿°'] : '')))
                });
            });

            renderSceneData();
        }

        function addSceneData() {

        }
        
        function renderSceneData() {
            dataBody.innerHTML = '';
            
            sceneData.forEach((scene, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;

                const numberCell = document.createElement('td');
                numberCell.textContent = scene.number;
                numberCell.style.textAlign = 'center';
                sceneCounter = scene.number;

                const startCell = document.createElement('td');
                startCell.className = 'time-cell';
                startCell.textContent = formatExcelTime(scene.startTime);
                startCell.dataset.time = convertToSeconds(startCell.textContent);
                startCell.title = "ç‚¹å‡»è·³è½¬åˆ°åœºæ™¯å¼€å§‹æ—¶é—´";
                startCell.style.textAlign = 'center';
                startCell.onclick = function() {
                    jumpToVideoTime(this.dataset.time, index);
                };

                const endCell = document.createElement('td');
                endCell.className = 'time-cell';
                endCell.textContent = formatExcelTime(scene.endTime);
                endCell.dataset.time = convertToSeconds(endCell.textContent);
                endCell.title = "ç‚¹å‡»è·³è½¬åˆ°åœºæ™¯ç»“æŸæ—¶é—´";
                endCell.style.textAlign = 'center';
                endCell.onclick = function() {
                    jumpToVideoTime(this.dataset.time, index);
                };

                const labelCell = document.createElement('td');
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.value = scene.label;
                labelInput.addEventListener('input', function () {
                    sceneData[index].label = labelInput.value;
                });
                labelCell.appendChild(labelInput);

                const difficultyCell = document.createElement('td');
                const difficultyInput = document.createElement('input');
                difficultyInput.type = 'text';
                difficultyInput.value = scene.difficulty;
                difficultyInput.addEventListener('input', function () {
                    sceneData[index].difficulty = difficultyInput.value;
                });
                difficultyCell.appendChild(difficultyInput);

                const remarkCell = document.createElement('td');
                const remarkInput = document.createElement('input');
                remarkInput.type = 'text';
                remarkInput.value = scene.remark;
                remarkInput.style.textAlign = 'left';
                remarkInput.addEventListener('input', function () {
                    sceneData[index].remark = remarkInput.value;
                });
                remarkCell.appendChild(remarkInput);

                const anquanCell = document.createElement('td');
                const anquanInput = document.createElement('input');
                anquanInput.type = 'text';
                anquanInput.value = scene.anquan;
                anquanInput.addEventListener('input', function () {
                    sceneData[index].anquan = anquanInput.value;
                });
                anquanCell.appendChild(anquanInput);

                const xiaolvCell = document.createElement('td');
                const xiaolvInput = document.createElement('input');
                xiaolvInput.type = 'text';
                xiaolvInput.value = scene.xiaolv;
                xiaolvInput.addEventListener('input', function () {
                    sceneData[index].xiaolv = xiaolvInput.value;
                });
                xiaolvCell.appendChild(xiaolvInput);

                const shushiCell = document.createElement('td');
                const shushiInput = document.createElement('input');
                shushiInput.type = 'text';
                shushiInput.value = scene.shushi;
                shushiInput.addEventListener('input', function () {
                    sceneData[index].shushi = shushiInput.value;
                });
                shushiCell.appendChild(shushiInput);

                const nrhremarkCell = document.createElement('td');
                const nrhremarkInput = document.createElement('input');
                nrhremarkInput.type = 'text';
                nrhremarkInput.value = scene.nrhremark;
                nrhremarkInput.style.textAlign = 'left';
                nrhremarkInput.addEventListener('input', function () {
                    sceneData[index].nrhremark = nrhremarkInput.value;
                });
                nrhremarkCell.appendChild(nrhremarkInput);

                row.appendChild(numberCell);
                row.appendChild(startCell);
                row.appendChild(endCell);
                row.appendChild(labelCell);
                row.appendChild(difficultyCell);
                row.appendChild(remarkCell);
                row.appendChild(anquanCell);
                row.appendChild(xiaolvCell);
                row.appendChild(shushiCell);
                row.appendChild(nrhremarkCell);

                dataBody.appendChild(row);
            });
        }
        
        function formatExcelTime(time) {
            if (time instanceof Date && isNaN(time.getTime())) {
            const rawValue = time.valueOf();
            const numericValue = parseFloat(rawValue)
            const baseDate = new Date(Date.UTC(1899, 11, 30));
            const excelDate = new Date(baseDate.getTime() + numericValue * 86400 * 1000);
            const hours = excelDate.getUTCHours().toString().padStart(2, '0');
            const minutes = excelDate.getUTCMinutes().toString().padStart(2, '0');
            const seconds = excelDate.getUTCSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
            } else if (time instanceof Date) {
                const hours = time.getHours().toString().padStart(2, '0');
                const minutes = time.getMinutes().toString().padStart(2, '0');
                const seconds = time.getSeconds().toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            } else if (typeof time === 'number') {
                const totalSeconds = time * 86400;
                const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
                const seconds = Math.floor(totalSeconds % 60).toString().padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            } else if (typeof time === 'string' && /^\d{1,2}:\d{2}:\d{2}$/.test(time)) {
                const parts = time.split(':');
                if (parts[0].length === 1) {
                    parts[0] = parts[0].padStart(2, '0');
                }
                return parts.join(':');
            }
            return time;
        }
        
        function convertToSeconds(timeString) {
            if (typeof timeString === 'string' && /^\d{2}:\d{2}:\d{2}$/.test(timeString)) {
                const [hours, minutes, seconds] = timeString.split(':').map(Number);
                return hours * 3600 + minutes * 60 + seconds;
            }
            return 0;
        }
        
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const secs = Math.floor(seconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${secs}`;
        }
        
        function jumpToVideoTime(timeInSeconds, rowIndex) {
            if (!videoPlayer.src) {
                videoStatusElement.textContent = "è¯·å…ˆåŠ è½½è§†é¢‘æ–‡ä»¶";
                return;
            }
            
            videoPlayer.currentTime = parseFloat(timeInSeconds);
            videoPlayer.play();
            
            videoStatusElement.textContent = `è·³è½¬åˆ°: ${formatTime(timeInSeconds)}`;
            
            updateHighlight(rowIndex);
        }

        const exportButton = document.getElementById('exportButton');
        let loadedExcelFileName = '';

        excelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                loadedExcelFileName = file.name.split('.').slice(0, -1).join('.');
            }
        });

        exportButton.addEventListener('click', function() {
            if (sceneData.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„åœºæ™¯æ•°æ®ï¼');
                return;
            }

            const worksheet = XLSX.utils.json_to_sheet(sceneData.map(scene => ({
                ç¼–å·: Number(scene.number) || 0,
                å¼€å§‹æ—¶é—´: scene.startTime,
                ç»“æŸæ—¶é—´: scene.endTime,
                åœºæ™¯æ ‡ç­¾: scene.label,
                éš¾åº¦: Number(scene.difficulty),
                å¼‚å¸¸æƒ…å†µå¤‡æ³¨: scene.remark,
                å®‰å…¨: Number(scene.anquan) || 1,
                æ•ˆç‡: Number(scene.xiaolv) || 1,
                èˆ’é€‚: Number(scene.shushi) || 1,
                æ€»åˆ†: Math.max(Number(scene.anquan) || 1, Number(scene.xiaolv) || 1, Number(scene.shushi) || 1),
                æ‹ŸäººåŒ–æƒ…å†µå¤‡æ³¨: scene.nrhremark
            })));
            ['A', 'E', 'G', 'H', 'I', 'J'].forEach(col => {
                for (let row = 2; row <= sceneData.length + 1; row++) {
                    const cell = worksheet[`${col}${row}`];
                    if (cell) {
                        cell.t = 'n';
                    }
                }
            });
            ['B', 'C'].forEach(col => {
                for (let row = 2; row <= sceneData.length + 1; row++) {
                    const cell = worksheet[`${col}${row}`];
                    if (cell) {
                        cell.z = 'hh:mm:ss';
                    }
                }
            });
            ['D', 'F', 'K'].forEach(col => {
                for (let row = 2; row <= sceneData.length + 1; row++) {
                    const cell = worksheet[`${col}${row}`];
                    if (cell) {
                        cell.t = 's';
                    }
                }
            });
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'æ ¡éªŒæ•°æ®');

            const exportFileName = `${loadedExcelFileName || 'åœºæ™¯æ•°æ®'}_æ ¡éªŒ.xlsx`;

            XLSX.writeFile(workbook, exportFileName);
        });

        document.getElementById('playButton').addEventListener('click', function () {
            if (videoPlayer.paused) {
                videoPlayer.play();
            }
            else {
                videoPlayer.pause();
            }
        });
        
        document.getElementById('fastForwardButton').addEventListener('click', function () {
            if (videoPlayer) {
                videoPlayer.currentTime += 1;
            }
        });
         
        document.getElementById('rewindButton').addEventListener('click', function () {
            if (videoPlayer) {
                videoPlayer.currentTime -= 1;
            }
        });

    </script>
</body>
</html>